// PulseForge — Market Macro Intelligence Dashboard
// Loads data from /data/*.json (generated by GitHub Actions pipeline)

const DATA_BASE = 'data';
const PLOTLY_DARK = {
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    font: { family: 'Inter, sans-serif', color: '#94a3b8', size: 12 },
    xaxis: { gridcolor: '#1e293b', linecolor: '#2a3a4e', zerolinecolor: '#2a3a4e' },
    yaxis: { gridcolor: '#1e293b', linecolor: '#2a3a4e', zerolinecolor: '#2a3a4e' },
    margin: { l: 50, r: 20, t: 30, b: 40 },
    hoverlabel: { bgcolor: '#1a2332', bordercolor: '#3b82f6', font: { color: '#e2e8f0' } }
};

const PLOTLY_CONFIG = { responsive: true, displayModeBar: false };

// ── Utilities ──
function fmt(n, decimals = 2) {
    if (n == null) return '--';
    return Number(n).toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}

function fmtChange(current, previous) {
    if (current == null || previous == null) return { text: '--', cls: 'flat' };
    const diff = current - previous;
    const pct = ((diff / Math.abs(previous)) * 100).toFixed(2);
    const sign = diff >= 0 ? '+' : '';
    const cls = diff > 0 ? 'up' : diff < 0 ? 'down' : 'flat';
    return { text: `${sign}${pct}%`, cls };
}

function regimeColor(score) {
    if (score < 30) return { label: 'EXTREME FEAR', cls: 'fear', color: '#ef4444' };
    if (score < 45) return { label: 'FEAR', cls: 'fear', color: '#f97316' };
    if (score < 55) return { label: 'NEUTRAL', cls: 'neutral', color: '#f59e0b' };
    if (score < 70) return { label: 'GREED', cls: 'neutral', color: '#84cc16' };
    return { label: 'EXTREME GREED', cls: 'greed', color: '#10b981' };
}

async function loadJSON(filename) {
    try {
        const resp = await fetch(`${DATA_BASE}/${filename}`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return await resp.json();
    } catch (e) {
        console.warn(`Failed to load ${filename}:`, e.message);
        return null;
    }
}

// ── Sparkline (mini Plotly chart in metric card) ──
function renderSparkline(elementId, values, color = '#3b82f6') {
    const el = document.getElementById(elementId);
    if (!el || !values || values.length < 2) return;

    Plotly.newPlot(el, [{
        y: values.slice(-30),
        type: 'scatter',
        mode: 'lines',
        line: { color, width: 1.5, shape: 'spline' },
        fill: 'tozeroy',
        fillcolor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
        hoverinfo: 'skip'
    }], {
        ...PLOTLY_DARK,
        margin: { l: 0, r: 0, t: 0, b: 0 },
        xaxis: { visible: false },
        yaxis: { visible: false },
        height: 40
    }, { ...PLOTLY_CONFIG, staticPlot: true });
}

// ── Render Sections ──
function renderMetrics(data) {
    if (!data) return;

    const metrics = [
        { id: 'vix', key: 'VIX', color: '#ef4444', decimals: 2 },
        { id: 'spy', key: 'SPY', color: '#3b82f6', decimals: 2 },
        { id: 'dxy', key: 'DXY', color: '#8b5cf6', decimals: 2 },
        { id: 'tny', key: 'TNX', color: '#f59e0b', decimals: 3 },
        { id: 'btc', key: 'BTC', color: '#f97316', decimals: 0 },
        { id: 'oil', key: 'CL', color: '#10b981', decimals: 2 }
    ];

    metrics.forEach(({ id, key, color, decimals }) => {
        const series = data[key];
        if (!series) return;
        const values = series.values || [];
        const current = values[values.length - 1];
        const previous = values[values.length - 2];

        document.getElementById(`${id}Value`).textContent = fmt(current, decimals);
        const change = fmtChange(current, previous);
        const changeEl = document.getElementById(`${id}Change`);
        changeEl.textContent = change.text;
        changeEl.className = `metric-change ${change.cls}`;

        renderSparkline(`${id}Spark`, values, color);
    });
}

function renderPulseChart(data) {
    if (!data || !data.dates || !data.scores) return;

    const colors = data.scores.map(s => {
        if (s < 30) return '#ef4444';
        if (s < 45) return '#f97316';
        if (s < 55) return '#f59e0b';
        if (s < 70) return '#84cc16';
        return '#10b981';
    });

    Plotly.newPlot('pulseChart', [
        {
            x: data.dates,
            y: data.scores,
            type: 'scatter',
            mode: 'lines+markers',
            line: { color: '#3b82f6', width: 2, shape: 'spline' },
            marker: { color: colors, size: 5 },
            fill: 'tozeroy',
            fillcolor: 'rgba(59, 130, 246, 0.08)',
            name: 'Pulse Score'
        },
        {
            x: data.dates,
            y: Array(data.dates.length).fill(30),
            type: 'scatter',
            mode: 'lines',
            line: { color: '#ef4444', width: 1, dash: 'dot' },
            name: 'Fear Zone',
            hoverinfo: 'skip'
        },
        {
            x: data.dates,
            y: Array(data.dates.length).fill(70),
            type: 'scatter',
            mode: 'lines',
            line: { color: '#10b981', width: 1, dash: 'dot' },
            name: 'Greed Zone',
            hoverinfo: 'skip'
        }
    ], {
        ...PLOTLY_DARK,
        showlegend: true,
        legend: { orientation: 'h', y: -0.15, font: { size: 11 } },
        yaxis: { ...PLOTLY_DARK.yaxis, range: [0, 100], title: 'Pulse Score' },
        height: 380
    }, PLOTLY_CONFIG);

    // Update header pulse score
    const latestScore = data.scores[data.scores.length - 1];
    if (latestScore != null) {
        const regime = regimeColor(latestScore);
        document.getElementById('pulseScore').textContent = Math.round(latestScore);
        document.getElementById('pulseScore').style.color = regime.color;
        const regimeEl = document.getElementById('pulseRegime');
        regimeEl.textContent = regime.label;
        regimeEl.className = `pulse-regime ${regime.cls}`;
    }
}

function renderSectorChart(data) {
    if (!data || !data.sectors) return;

    const sectors = data.sectors;
    const names = Object.keys(sectors);
    const values = names.map(n => sectors[n].change_pct);
    const colors = values.map(v => v >= 0 ? '#10b981' : '#ef4444');

    Plotly.newPlot('sectorChart', [{
        x: names,
        y: values,
        type: 'bar',
        marker: { color: colors, line: { color: colors.map(c => c === '#10b981' ? '#059669' : '#dc2626'), width: 1 } },
        text: values.map(v => `${v >= 0 ? '+' : ''}${v.toFixed(2)}%`),
        textposition: 'outside',
        textfont: { family: 'JetBrains Mono', size: 11, color: '#94a3b8' },
        hovertemplate: '%{x}: %{y:.2f}%<extra></extra>'
    }], {
        ...PLOTLY_DARK,
        yaxis: { ...PLOTLY_DARK.yaxis, title: 'Change %', zeroline: true, zerolinecolor: '#3b82f6', zerolinewidth: 2 },
        height: 350
    }, PLOTLY_CONFIG);
}

function renderWatchlist(data) {
    if (!data || !data.stocks) return;

    const table = document.getElementById('watchlistTable');
    let html = `<table>
        <thead><tr>
            <th>Ticker</th><th>Price</th><th>Change</th><th>Volume</th><th>Signal</th><th>Notes</th>
        </tr></thead><tbody>`;

    data.stocks.forEach(s => {
        const changeCls = s.change_pct >= 0 ? 'up' : 'down';
        const signalCls = s.signal === 'BULLISH' ? 'bullish' : s.signal === 'BEARISH' ? 'bearish' : 'neutral';
        html += `<tr>
            <td class="ticker-cell">${s.ticker}</td>
            <td>$${fmt(s.price)}</td>
            <td class="metric-change ${changeCls}">${s.change_pct >= 0 ? '+' : ''}${fmt(s.change_pct)}%</td>
            <td>${s.volume ? (s.volume / 1e6).toFixed(1) + 'M' : '--'}</td>
            <td><span class="signal ${signalCls}">${s.signal || '--'}</span></td>
            <td style="color: var(--text-muted); font-family: var(--font-sans); font-size: 0.8rem;">${s.notes || ''}</td>
        </tr>`;
    });

    html += '</tbody></table>';
    table.innerHTML = html;
}

function renderVolChart(data) {
    if (!data) return;

    const traces = [];
    if (data.vix_history) {
        traces.push({
            x: data.vix_history.dates,
            y: data.vix_history.values,
            type: 'scatter',
            mode: 'lines',
            name: 'VIX',
            line: { color: '#ef4444', width: 2 },
            fill: 'tozeroy',
            fillcolor: 'rgba(239, 68, 68, 0.08)'
        });
    }
    if (data.vix_sma) {
        traces.push({
            x: data.vix_sma.dates,
            y: data.vix_sma.values,
            type: 'scatter',
            mode: 'lines',
            name: 'VIX 20-SMA',
            line: { color: '#f59e0b', width: 1.5, dash: 'dash' }
        });
    }

    if (traces.length) {
        Plotly.newPlot('volChart', traces, {
            ...PLOTLY_DARK,
            showlegend: true,
            legend: { orientation: 'h', y: -0.15 },
            yaxis: { ...PLOTLY_DARK.yaxis, title: 'VIX Level' },
            shapes: [
                { type: 'line', y0: 20, y1: 20, x0: 0, x1: 1, xref: 'paper', line: { color: '#f59e0b', width: 1, dash: 'dot' } },
                { type: 'line', y0: 30, y1: 30, x0: 0, x1: 1, xref: 'paper', line: { color: '#ef4444', width: 1, dash: 'dot' } }
            ],
            height: 350
        }, PLOTLY_CONFIG);
    }
}

function renderPredictions(data) {
    if (!data || !data.predictions) return;

    const grid = document.getElementById('predictionsGrid');
    let html = '';

    data.predictions.forEach(p => {
        const signalCls = p.direction === 'BULLISH' ? 'bullish' : p.direction === 'BEARISH' ? 'bearish' : 'neutral';
        html += `<div class="prediction-card">
            <h3>${p.name}</h3>
            <div class="signal ${signalCls}">${p.direction} ${p.direction === 'BULLISH' ? '↑' : p.direction === 'BEARISH' ? '↓' : '→'}</div>
            <div class="confidence">Confidence: ${p.confidence}% · Horizon: ${p.horizon}</div>
            <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">${p.rationale || ''}</div>
        </div>`;
    });

    grid.innerHTML = html;
}

function renderMacroNotes(data) {
    if (!data || !data.notes) return;
    const el = document.getElementById('macroNotes');
    let html = '<ul>';
    data.notes.forEach(n => { html += `<li>${n}</li>`; });
    html += '</ul>';
    el.innerHTML = html;
}

// ── Main Init ──
async function init() {
    document.getElementById('lastUpdated').textContent = 'Loading data...';

    const [metrics, pulse, sectors, watchlist, vol, predictions, macro] = await Promise.all([
        loadJSON('metrics.json'),
        loadJSON('pulse.json'),
        loadJSON('sectors.json'),
        loadJSON('watchlist.json'),
        loadJSON('volatility.json'),
        loadJSON('predictions.json'),
        loadJSON('macro.json')
    ]);

    renderMetrics(metrics);
    renderPulseChart(pulse);
    renderSectorChart(sectors);
    renderWatchlist(watchlist);
    renderVolChart(vol);
    renderPredictions(predictions);
    renderMacroNotes(macro);

    // Update timestamp
    const ts = pulse?.last_updated || metrics?.last_updated || new Date().toISOString();
    document.getElementById('lastUpdated').textContent = `Updated: ${new Date(ts).toLocaleString('en-US', { timeZone: 'America/New_York' })} ET`;
}

document.addEventListener('DOMContentLoaded', init);
